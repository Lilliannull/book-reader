<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{{ file_name }}</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        button {
            margin-right: 10px;
            padding: 6px 12px;
        }
        pre {
            white-space: pre-wrap;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
        }
        #batch-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 10px 16px;
            background-color: #1d72b8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>

    <h2>{{ file_name }}</h2>

    <button onclick="startReading()">â–¶ï¸ Start</button>
    <button onclick="pauseReading()">â¸ï¸ Pause</button>
    <button onclick="resumeReading()">â¯ï¸ Resume</button>
    <button onclick="stopReading()">â¹ï¸ Stop</button>
    <button type="button" onclick="translateBatch()" id="batch-btn">ğŸŒ ç¿»è¯‘ä¸‹ä¸€æ‰¹ (50æ®µ)</button>


    <div id="book-content">
        {% for en in paragraphs %}
        <div id="para-{{ loop.index }}" style="margin-bottom: 20px;">
            <p><strong>ğŸ“˜ ç¬¬ {{ loop.index }} æ®µï¼š</strong><br>â–¶ï¸ {{ en }}</p>
            <p id="zh-{{ loop.index }}" style="display: none; color: gray;"></p>
            <button onclick="translateOne({{ loop.index }}, '{{ en | replace("'", "\\'") }}')" id="btn-{{ loop.index }}">ğŸŒ ç¿»è¯‘</button>
            <hr>
        </div>
        {% endfor %}
    </div>


    <br><br><a href="/">â¬… Back</a>

    <script>
        let utterance = null;
        let isPaused = false;
        let isStarted = false;

        function initUtterance() {
            if (!utterance) {
                const text = document.getElementById("book-content").innerText.slice(0, 1000);
                utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = "en-US";

                utterance.onend = function() {
                    isStarted = false;
                    isPaused = false;
                    utterance = null;
                    console.log("æœ—è¯»ç»“æŸ");
                };
            }
        }

        function startReading() {
            speechSynthesis.cancel(); // ç¡®ä¿ä¸ä¼šé‡å 
            initUtterance();
            isPaused = false;
            isStarted = true;
            speechSynthesis.speak(utterance);
        }

        function pauseReading() {
            if (isStarted && !isPaused && speechSynthesis.speaking) {
                speechSynthesis.pause();
                isPaused = true;
            }
        }

        function resumeReading() {
            if (isStarted && isPaused && speechSynthesis.paused) {
                speechSynthesis.resume();
                isPaused = false;
            }
        }

        function stopReading() {
            speechSynthesis.cancel();
            isPaused = false;
            isStarted = false;
            utterance = null;
        }

        async function translateOne(index, enText) {
            const zhElem = document.getElementById("zh-" + index);
            const btn = document.getElementById("btn-" + index);

            btn.innerText = "â³ ç¿»è¯‘ä¸­...";
            btn.disabled = true;

            const response = await fetch("/translate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: enText })
            });

            const data = await response.json();
            zhElem.innerText = data.translation;
            zhElem.style.display = "block";
            btn.innerText = "âœ… å·²ç¿»è¯‘";
        }

        let currentIndex = 1;
        const batchSize = 50;
        const totalParagraphs = {{ paragraphs|length }};

        async function translateBatch() {
            const btn = document.getElementById("batch-btn");
            btn.innerText = "â³ æ­£åœ¨æŸ¥æ‰¾å½“å‰ä½ç½®...";
            btn.disabled = true;

            const allParas = document.querySelectorAll("div[id^='para-']");
            const viewportTop = window.scrollY;
            let startIndex = 1;

            for (let i = 0; i < allParas.length; i++) {
                const rect = allParas[i].getBoundingClientRect();
                const absTop = rect.top + window.scrollY;
                if (absTop >= viewportTop) {
                    startIndex = i + 1;
                    break;
                }
            }

            const batchSize = 50;
            const total = allParas.length;

            btn.innerText = `â³ æ­£åœ¨ç¿»è¯‘ç¬¬ ${startIndex} ~ ${Math.min(startIndex + batchSize - 1, total)} æ®µ...`;

            for (let i = startIndex; i < startIndex + batchSize && i <= total; i++) {
                const zhElem = document.getElementById("zh-" + i);
                const btnElem = document.getElementById("btn-" + i);
                if (!btnElem || !zhElem) continue;

                if (zhElem.innerText.trim() !== "") continue;

                const enText = btnElem.getAttribute("onclick")
                    .match(/translateOne\(\d+, '(.*)'\)/)[1]
                    .replace(/\\'/g, "'");

                btnElem.innerText = "â³ ç¿»è¯‘ä¸­...";
                btnElem.disabled = true;

                const res = await fetch("/translate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: enText })
                });

                const data = await res.json();
                zhElem.innerText = data.translation;
                zhElem.style.display = "block";
                btnElem.innerText = "âœ… å·²ç¿»è¯‘";
            }

            let hasUntranslated = false;
            for (let i = 1; i <= total; i++) {
                const zh = document.getElementById("zh-" + i);
                if (zh && zh.innerText.trim() === "") {
                    hasUntranslated = true;
                    break;
                }
            }

            if (!hasUntranslated) {
                btn.innerText = "âœ… æ‰€æœ‰æ®µè½å·²ç¿»è¯‘";
                btn.disabled = true;
            } else {
                btn.innerText = `ğŸŒ ç¿»è¯‘ä¸‹ä¸€æ‰¹ (${batchSize}æ®µ)`;
                btn.disabled = false;
            }

        }


        // è‡ªåŠ¨è®°å½•æ»šåŠ¨ä½ç½®ï¼ˆæ¯æ¬¡æ»šåŠ¨æ—¶ï¼‰
        window.addEventListener("scroll", () => {
            localStorage.setItem("book-scroll-position", window.scrollY);
        });

        // é¡µé¢åŠ è½½å®Œåè‡ªåŠ¨æ¢å¤æ»šåŠ¨ä½ç½®
        window.addEventListener("load", () => {
            const savedY = localStorage.getItem("book-scroll-position");
            if (savedY !== null) {
                window.scrollTo({ top: parseInt(savedY), behavior: "smooth" });
            }
        });


    </script>

</body>
</html>
